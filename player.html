<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <style>
    html, body {
      margin:0; padding:0;
      background:#000;
      width:100%; height:100%;
      overflow:hidden;
    }
    iframe {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      border: 0;
    }
  </style>
</head>
<body>
  <iframe id="playerIframe"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
    referrerpolicy="strict-origin-when-cross-origin"
    allowfullscreen></iframe>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    function getParam(name, defVal) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name) ?? defVal;
    }

    var player;
    var watchedTime = 0;
    var watchTimerId = null;

    var videoId = getParam("v", "0Pp8jcQ97pY");
    var startAt = parseInt(getParam("start", "0"), 10) || 0;
    var origin = window.location.origin;

    var iframe = document.getElementById("playerIframe");
    iframe.src =
      "https://www.youtube-nocookie.com/embed/" + encodeURIComponent(videoId) +
      "?enablejsapi=1&rel=0&modestbranding=1&playsinline=0&autoplay=1&mute=1" +
      "&start=" + startAt +
      "&origin=" + encodeURIComponent(origin);

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('playerIframe', {
        events: { onStateChange: onPlayerStateChange }
      });
    }

    function onPlayerStateChange(event) {
      var state = event.data;
      var videoTime = Math.floor(player.getCurrentTime() || 0);

      if (state === YT.PlayerState.PLAYING) {
        window.location.href = 'ytplay://' + videoId + '?t=' + videoTime + '&w=' + watchedTime;

        if (watchTimerId !== null) clearInterval(watchTimerId);
        watchTimerId = setInterval(function() {
          watchedTime += 1;
          var nowT = Math.floor(player.getCurrentTime() || 0);
          window.location.href = 'ytplaying://' + videoId + '?t=' + nowT + '&w=' + watchedTime;
        }, 1000);
      } else if (state === YT.PlayerState.PAUSED) {
        if (watchTimerId !== null) { clearInterval(watchTimerId); watchTimerId = null; }
        window.location.href = 'ytpause://' + videoId + '?t=' + videoTime + '&w=' + watchedTime;
      } else if (state === YT.PlayerState.ENDED) {
        if (watchTimerId !== null) { clearInterval(watchTimerId); watchTimerId = null; }
        window.location.href = 'ytend://' + videoId + '?t=' + videoTime + '&w=' + watchedTime;
      }
    }
  </script>
</body>
</html>
